{% extends 'base.html' %}

{% block content %}
<!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è JavaScript -->
{% csrf_token %}

<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-2">
  <h1 class="fw-bold mb-0">–°–≤—è–∑—å —Å Telegram</h1>
                </div>
                    
                    {% if telegram_info.is_telegram_user %}
                        <!-- –ê–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å–≤—è–∑–∞–Ω -->
                        <div class="alert alert-success">
        <h5 class="alert-heading">‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–≤—è–∑–∞–Ω —Å Telegram</h5>
                            <p class="mb-0">
                                –í–∞—à –∞–∫–∫–∞—É–Ω—Ç <strong>{{ user.username }}</strong> —Å–≤—è–∑–∞–Ω —Å Telegram.
                            </p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–≤—è–∑–∏:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Telegram ID:</strong> {{ telegram_info.telegram_id }}</li>
                                    {% if telegram_info.telegram_username %}
                                        <li><strong>Telegram Username:</strong> @{{ telegram_info.telegram_username }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç:</h6>
                                <ul class="list-unstyled">
                                    <li>‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫</li>
                                    <li>‚úÖ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</li>
                                    <li>‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ Telegram</li>
                                    <li>‚úÖ –¢–µ—Å—Ç—ã –≤ –±–æ—Ç–µ</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-3">
        <a href="{{ bot_url }}" class="btn btn-primary" target="_blank">
            –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram
                            </a>
                        </div>
                        
                    {% else %}
                        <!-- –ê–∫–∫–∞—É–Ω—Ç –Ω–µ —Å–≤—è–∑–∞–Ω -->
                        <div class="alert alert-info">
        <h5 class="alert-heading">üîó –°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —Å Telegram</h5>
                            <p class="mb-0">
                                –°–≤—è–∂–∏—Ç–µ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç —Å Telegram –±–æ—Ç–æ–º –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
                            </p>
                        </div>
                        
    <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∏:</h6>
                                <ul>
                                    <li>üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è—Ö</li>
                                    <li>üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</li>
                                    <li>üìù –¢–µ—Å—Ç—ã –≤ Telegram</li>
                                    <li>üîä –û–∑–≤—É—á–∫–∞ —Å–ª–æ–≤</li>
                                </ul>
        </div>
        <div class="col-md-6">
            <h6>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h6>
            <ol>
                <li>–ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É"</li>
                <li>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ</li>
                <li>–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∂–µ—Ç –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç</li>
            </ol>
        </div>
    </div>
    
    <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏–≤—è–∑–∫–∏ -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
        <button id="generateLinkBtn" class="btn btn-success btn-lg">
            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏
        </button>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ -->
    <div id="linkResult" style="display: none;">
        <div class="alert alert-success">
            <h6>‚úÖ –°—Å—ã–ª–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!</h6>
            <p class="mb-2">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.</p>
            <small class="text-muted">–°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 5 –º–∏–Ω—É—Ç</small>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">QR-–∫–æ–¥ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ</h6>
                    </div>
                    <div class="card-body text-center">
                        <div id="qrCodeContainer">
                            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç QR-–∫–æ–¥ –∏–ª–∏ —Å–ø–∏–Ω–Ω–µ—Ä -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">–°—Å—ã–ª–∫–∞:</label>
                            <div class="input-group">
                                <input type="text" id="botLink" class="form-control" readonly>
                                <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('botLink')">
                                    <span id="copyBtnText">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                                </button>
                            </div>
                        </div>
                        <a id="openBotBtn" href="" class="btn btn-primary w-100" target="_blank">
                            –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="progress" style="height: 8px;">
                <div id="tokenProgress" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
            </div>
            <small class="text-muted">–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è: <span id="tokenTimeLeft">5:00</span></small>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="mt-4">
        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#manualForm">
            –†—É—á–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ (–µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        </button>
        
        <div class="collapse" id="manualForm">
            <div class="card card-body mt-2">
                <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="link">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="telegram_id" class="form-label">Telegram ID *</label>
                                        <input type="number" class="form-control" id="telegram_id" 
                                               name="telegram_id" required 
                                               placeholder="123456789">
                                        <div class="form-text">–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –≤ Telegram</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="telegram_username" class="form-label">Telegram Username</label>
                                        <input type="text" class="form-control" id="telegram_username" 
                                               name="telegram_username" 
                                               placeholder="username">
                                        <div class="form-text">–í–∞—à username –≤ Telegram (–±–µ–∑ @)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success">
                            –°–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                                </button>
                            </div>
                        </form>
            </div>
        </div>
    </div>
{% endif %}

<script>
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏–≤—è–∑–∫–∏
document.getElementById('generateLinkBtn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        
        const response = await fetch('{% url "users:generate_link_token" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('linkResult').style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ QR-–∫–æ–¥–∞
            document.getElementById('qrCodeContainer').innerHTML = 
                '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div><br><small>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞...</small>';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º QR-–∫–æ–¥
            const qrImg = new Image();
            qrImg.onload = function() {
                // QR-–∫–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ
                document.getElementById('qrCodeContainer').innerHTML = 
                    '<img src="' + data.qr_url + '" alt="QR-–∫–æ–¥" class="img-fluid border rounded" style="max-width: 200px; height: auto;">';
            };
            qrImg.onerror = function() {
                // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR-–∫–æ–¥–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                console.log('QR –∫–æ–¥ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è:', data.qr_url);
                document.getElementById('qrCodeContainer').innerHTML = 
                    '<div class="alert alert-warning text-start">' +
                    '<h6>–û—à–∏–±–∫–∞ QR-–∫–æ–¥–∞</h6>' +
                    '<p class="mb-2">QR-–∫–æ–¥ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å.</p>' +
                    '<h6>–ö–∞–∫ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç:</h6>' +
                    '<ol class="mb-0">' +
                    '<li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram" —Å–ø—Ä–∞–≤–∞</li>' +
                    '<li>–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>' +
                    '<li>Telegram –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ—Ç –±–æ—Ç–∞</li>' +
                    '<li>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω</li>' +
                    '</ol>' +
                    '</div>';
            };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º QR-–∫–æ–¥
            qrImg.src = data.qr_url;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É
            document.getElementById('botLink').value = data.bot_url;
            document.getElementById('openBotBtn').href = data.bot_url;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            startTokenTimer(data.expires_at);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            document.getElementById('linkResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const copyBtn = document.getElementById('copyBtnText');
    const originalText = copyBtn.innerHTML;
    
    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç
    element.select();
    element.setSelectionRange(0, 99999);
    
    try {
        // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        document.execCommand('copy');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        copyBtn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        copyBtn.style.color = '#28a745';
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.style.color = '';
        }, 2000);
        
    } catch (err) {
        // Fallback –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        if (navigator.clipboard) {
            navigator.clipboard.writeText(element.value).then(() => {
                copyBtn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                copyBtn.style.color = '#28a745';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.color = '';
                }, 2000);
            });
        } else {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
        }
    }
}

// –¢–∞–π–º–µ—Ä –¥–ª—è —Ç–æ–∫–µ–Ω–∞
function startTokenTimer(expiresAt) {
    const progressBar = document.getElementById('tokenProgress');
    const timeLeft = document.getElementById('tokenTimeLeft');
    
    const updateTimer = () => {
        const now = new Date().getTime();
        const expires = new Date(expiresAt).getTime();
        const timeRemaining = expires - now;
        
        if (timeRemaining <= 0) {
            progressBar.style.width = '0%';
            progressBar.className = 'progress-bar bg-danger';
            timeLeft.textContent = '–ò—Å—Ç–µ–∫–ª–æ';
            document.getElementById('linkResult').style.display = 'none';
            return;
        }
        
        const minutes = Math.floor(timeRemaining / 60000);
        const seconds = Math.floor((timeRemaining % 60000) / 1000);
        timeLeft.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const totalTime = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        const progress = (timeRemaining / totalTime) * 100;
        progressBar.style.width = progress + '%';
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
        if (progress < 20) {
            progressBar.className = 'progress-bar bg-warning';
        } else if (progress < 50) {
            progressBar.className = 'progress-bar bg-info';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
    };
    
    updateTimer();
    const interval = setInterval(updateTimer, 1000);
    
    // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    setTimeout(() => {
        clearInterval(interval);
    }, 5 * 60 * 1000);
}
</script>
{% endblock %} 